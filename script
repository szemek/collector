#!/usr/bin/env ruby
# encoding: UTF-8

require 'pry'
require 'httparty'
require 'nokogiri'
require 'sequel'
require 'dotenv'
require 'set'
require 'uri'
require 'colored'

class Spider
  attr_accessor :resources, :visited_links, :unvisited_links

  def initialize(start_page, host)
    @start_page = start_page
    @host = host

    @visited_links = Set.new
    @unvisited_links = Set.new
    @resources = Set.new
  end

  def run
    visit!(@start_page)

    until @unvisited_links.empty?
      Set.new(@unvisited_links).each{|link| visit!(link)}
    end
  end

  def visit!(page)
    @visited_links.add(page)

    response = HTTParty.get(page)
    doc = Nokogiri::HTML(response.body)

    links = resources(doc, 'a[href]', 'href')

    scripts = resources(doc, 'script[src]', 'src')
    stylesheets = resources(doc, 'link[rel=stylesheet]', 'href')
    images = resources(doc, 'img[src]', 'src')

    @resources.merge(scripts + stylesheets + images)

    @unvisited_links.merge(links)
    @unvisited_links.subtract(@visited_links)

    puts "visited: #{@visited_links.count}".green
    puts "unvisited: #{@unvisited_links.count}".green
  end

  def resources(document, selector, attribute)
    document.css(selector).map{|e| e[attribute]}.select{|resource| filter_by_host(resource)}
  end

  def filter_by_host(resource)
    begin
      uri = URI(resource)
    rescue URI::InvalidURIError => error
      puts "#{error.message}".yellow
      return false
    end

    uri.host == @host
  end
end

Dotenv.load

page = ENV['PAGE']
host = ENV['HOST']

spider = Spider.new(page, host)
spider.run

binding.pry
